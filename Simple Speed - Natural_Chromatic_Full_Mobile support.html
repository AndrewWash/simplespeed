<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Speed - Absolute Pitch Trainer (Unified)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            /* Prevent text selection on mobile */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        /* Upload Screen Styles */
        .upload-screen {
            display: block;
        }
        
        .upload-screen.hidden {
            display: none;
        }
        
        .upload-section {
            margin-bottom: 30px;
        }
        
        .drag-drop-zone {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .drag-drop-zone:hover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        
        .drag-drop-zone.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
            transform: scale(1.02);
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .note-section {
            margin-bottom: 25px;
        }
        
        .note-section h4 {
            text-align: center;
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }
        
        .naturals {
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            background-color: #f8fff9;
        }
        
        .sharps {
            border: 2px solid #6f42c1;
            border-radius: 10px;
            padding: 20px;
            background-color: #f8f7ff;
        }
        
        .file-upload label {
            display: block;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
            font-weight: bold;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .file-upload label:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .file-upload label.uploaded {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.incomplete {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.complete {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.naturals-ready {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }
        
        /* Mode Selection */
        .mode-selection {
            margin-top: 20px;
            display: none;
        }
        
        .mode-selection.show {
            display: block;
        }
        
        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .mode-btn {
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .mode-btn:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .mode-btn.naturals {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .mode-btn.naturals:hover {
            background-color: #e8f5e8;
        }
        
        .mode-btn.chromatic {
            border-color: #6f42c1;
            background-color: #f8f7ff;
        }
        
        .mode-btn.chromatic:hover {
            background-color: #f0efff;
        }
        
        /* Game Screen Styles */
        .game-screen {
            display: none;
        }
        
        .game-screen.active {
            display: block;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .back-to-upload {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .back-to-upload:hover {
            background-color: #5a6268;
        }
        
        .phase-indicator {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
            color: #666;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .target-note {
            text-align: center;
            font-size: 72px;
            font-weight: bold;
            margin: 30px 0;
            padding: 40px;
            background-color: white;
            border-radius: 12px;
            border: 3px solid #007bff;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .controls button {
            padding: 20px 40px;
            margin: 0 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .start-btn {
            background-color: #28a745;
            color: white;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        }
        
        .start-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
        }
        
        .start-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Mobile Response Button */
        .response-button {
            width: 100%;
            max-width: 300px;
            height: 120px;
            margin: 20px auto;
            display: none;
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 8px 20px rgba(30, 58, 138, 0.3);
            /* Prevent text selection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Prevent touch callouts */
            -webkit-touch-callout: none;
            /* Prevent tap highlight */
            -webkit-tap-highlight-color: transparent;
        }
        
        .response-button.show {
            display: block;
        }
        
        .response-button:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #1e40af, #1d4ed8);
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.5);
        }
        
        .response-button:hover {
            background: linear-gradient(135deg, #1e40af, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(30, 58, 138, 0.4);
        }
        
        /* Input Method Indicator */
        .input-methods {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            display: none;
        }
        
        .input-methods.show {
            display: block;
        }
        
        .input-methods h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .input-methods p {
            margin: 5px 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        /* Randomize Toggle */
        .randomize-option {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background-color: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .toggle-switch.active {
            background-color: #007bff;
        }
        
        .toggle-switch .slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch.active .slider {
            transform: translateX(30px);
        }
        
        .toggle-label {
            font-weight: bold;
            font-size: 16px;
        }
        
        .toggle-description {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .spacebar-hint {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            border-left: 5px solid #007bff;
        }
        
        /* Fixed Feedback Container */
        .feedback-container {
            text-align: center;
            margin: 20px 0;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .feedback {
            font-weight: bold;
            font-size: 18px;
            opacity: 0;
            transition: all 0.3s ease;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
        }
        
        .feedback.show {
            opacity: 1;
        }
        
        .feedback.correct {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .feedback.incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .feedback.empty {
            background-color: transparent;
            color: #6c757d;
            border: none;
            font-style: italic;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            font-size: 12px;
            color: #495057;
            border-left: 4px solid #6c757d;
            display: none;
        }
        
        .ready-message {
            text-align: center;
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-radius: 10px;
            border: 2px solid #28a745;
        }
        
        .ready-message h2 {
            color: #155724;
            margin: 0 0 10px 0;
        }
        
        .ready-message p {
            color: #155724;
            margin: 0;
            font-size: 16px;
        }
        
        .mode-badge {
            display: inline-block;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .mode-badge.naturals {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .mode-badge.chromatic {
            background: linear-gradient(45deg, #6f42c1, #007bff);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .target-note {
                font-size: 48px;
                padding: 20px;
                margin: 20px 0;
            }
            
            .response-button {
                height: 100px;
                font-size: 20px;
                margin: 15px auto;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mode-buttons {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Upload Screen -->
        <div class="upload-screen" id="uploadScreen">
            <h1>Simple Speed - Absolute Pitch Trainer</h1>
            <p class="subtitle">Upload audio files to begin training</p>
            
            <div class="upload-section">
                <h3>Upload Audio Files</h3>
                <p>Upload natural notes (C-B) for basic training, or add sharps for complete chromatic training.</p>
                
                <div class="drag-drop-zone" id="dropZone">
                    <h3>Drag and drop your audio files here</h3>
                    <p>Natural notes: C.wav, D.wav, E.wav, F.wav, G.wav, A.wav, B.wav</p>
                    <p>Sharp notes: CSharp.wav (or C#.wav), DSharp.wav, FSharp.wav, GSharp.wav, ASharp.wav</p>
                    <p><em>Or click to browse files</em></p>
                    <input type="file" id="bulkUpload" multiple style="display: none;">
                </div>
                
                <div class="note-section naturals">
                    <h4>üéπ Natural Notes (7 files)</h4>
                    <div class="upload-grid">
                        <div class="file-upload">
                            <label for="fileC" id="labelC">
                                <strong>C</strong>
                                <small>C.wav</small>
                                <input type="file" id="fileC">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileD" id="labelD">
                                <strong>D</strong>
                                <small>D.wav</small>
                                <input type="file" id="fileD">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileE" id="labelE">
                                <strong>E</strong>
                                <small>E.wav</small>
                                <input type="file" id="fileE">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileF" id="labelF">
                                <strong>F</strong>
                                <small>F.wav</small>
                                <input type="file" id="fileF">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileG" id="labelG">
                                <strong>G</strong>
                                <small>G.wav</small>
                                <input type="file" id="fileG">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileA" id="labelA">
                                <strong>A</strong>
                                <small>A.wav</small>
                                <input type="file" id="fileA">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileB" id="labelB">
                                <strong>B</strong>
                                <small>B.wav</small>
                                <input type="file" id="fileB">
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="note-section sharps">
                    <h4>‚ôØ Sharp Notes (5 files) - Optional for Chromatic Mode</h4>
                    <div class="upload-grid">
                        <div class="file-upload">
                            <label for="fileCSharp" id="labelCSharp">
                                <strong>C#</strong>
                                <small>CSharp.wav</small>
                                <input type="file" id="fileCSharp">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileDSharp" id="labelDSharp">
                                <strong>D#</strong>
                                <small>DSharp.wav</small>
                                <input type="file" id="fileDSharp">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileFSharp" id="labelFSharp">
                                <strong>F#</strong>
                                <small>FSharp.wav</small>
                                <input type="file" id="fileFSharp">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileGSharp" id="labelGSharp">
                                <strong>G#</strong>
                                <small>GSharp.wav</small>
                                <input type="file" id="fileGSharp">
                            </label>
                        </div>
                        <div class="file-upload">
                            <label for="fileASharp" id="labelASharp">
                                <strong>A#</strong>
                                <small>ASharp.wav</small>
                                <input type="file" id="fileASharp">
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="status incomplete" id="status">
                    Upload audio files to begin training
                </div>
                
                <div class="mode-selection" id="modeSelection">
                    <h4>Choose Training Mode:</h4>
                    <div class="mode-buttons">
                        <div class="mode-btn naturals" id="naturalsBtn">
                            <h3>üéπ Natural Notes</h3>
                            <p>14 trials (7 notes √ó 2)</p>
                            <p>C, D, E, F, G, A, B</p>
                        </div>
                        <div class="mode-btn chromatic" id="chromaticBtn">
                            <h3>‚ôØ Complete Chromatic</h3>
                            <p>24 trials (12 notes √ó 2)</p>
                            <p>All notes including sharps</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <button class="back-to-upload" id="backToUpload">‚Üê Back to Upload</button>
            
            <div class="game-header">
                <h1>Simple Speed Training <span class="mode-badge" id="modeBadge">NATURALS</span></h1>
                <p class="subtitle">Respond when you hear the target note!</p>
            </div>
            
            <div class="ready-message" id="readyMessage">
                <h2>üéµ Ready to Train!</h2>
                <p id="readyDescription">Audio files loaded successfully. Configure your training options below.</p>
            </div>
            
            <div class="randomize-option">
                <div class="toggle-label">üé≤ Randomize Trial Order</div>
                <div class="toggle-container">
                    <span>Fixed Order</span>
                    <div class="toggle-switch" id="randomizeToggle">
                        <div class="slider"></div>
                    </div>
                    <span>Randomized</span>
                </div>
                <div class="toggle-description" id="toggleDescription">
                    Fixed order: C, D, E, F, G, A, B (repeated twice)
                </div>
            </div>
            
            <div class="phase-indicator" id="phaseIndicator">
                Ready to start - 14 trials ahead (7 notes √ó 2 repetitions)
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="trialCount">0</div>
                    <div class="stat-label">Trial</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="correctCount">0</div>
                    <div class="stat-label">Correct Hits</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="accuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="avgReactionTime">0ms</div>
                    <div class="stat-label">Avg Reaction Time</div>
                </div>
            </div>
            
            <div class="target-note" id="targetNote">Press Start to Begin</div>
            
            <div class="controls">
                <button class="start-btn" id="startBtn">Start Training (14 trials)</button>
            </div>
            
            <div class="input-methods" id="inputMethods">
                <h4>How to Respond:</h4>
                <p>üñ±Ô∏è <strong>Desktop:</strong> Press SPACEBAR when you hear the target note</p>
                <p>üì± <strong>Mobile:</strong> Tap the blue button when you hear the target note</p>
            </div>
            
            <!-- Mobile Response Button -->
            <button class="response-button" id="responseButton">
                TAP WHEN YOU HEAR TARGET
            </button>
            
            <!-- Fixed Feedback Container -->
            <div class="feedback-container">
                <div class="feedback empty" id="feedback">Feedback will appear here</div>
            </div>
            
            <!-- Debug info - HIDDEN during play but kept in code -->
            <div class="debug-info" id="debugInfo">
                Debug: Sequence will be generated for each trial
            </div>
        </div>
    </div>

    <script>
        // Note arrays for different modes
        const allNotes = ['C', 'CSharp', 'D', 'DSharp', 'E', 'F', 'FSharp', 'G', 'GSharp', 'A', 'ASharp', 'B'];
        const naturalNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        const sharpNotes = ['CSharp', 'DSharp', 'FSharp', 'GSharp', 'ASharp'];
        
        const noteDisplayNames = {
            'C': 'C', 'CSharp': 'C#', 'D': 'D', 'DSharp': 'D#', 'E': 'E', 'F': 'F', 
            'FSharp': 'F#', 'G': 'G', 'GSharp': 'G#', 'A': 'A', 'ASharp': 'A#', 'B': 'B'
        };
        
        const audioFiles = {};
        let uploadedNaturals = 0;
        let uploadedSharps = 0;
        
        // Training variables
        let currentMode = 'naturals';
        let activeNotes = [];
        let currentTrial = 0;
        let totalTrials = 14;
        let correctHits = 0;
        let totalHits = 0;
        let targetNote = '';
        let reactionTimes = [];
        let isSequencePlaying = false;
        let currentNoteIndex = 0;
        let noteSequence = [];
        let targetPositions = [];
        let noteTimeout;
        let trialOrder = [];
        let isRandomized = false;

        // Screen elements
        const uploadScreen = document.getElementById('uploadScreen');
        const gameScreen = document.getElementById('gameScreen');
        const modeSelection = document.getElementById('modeSelection');
        const randomizeToggle = document.getElementById('randomizeToggle');
        const toggleDescription = document.getElementById('toggleDescription');
        const responseButton = document.getElementById('responseButton');
        const inputMethods = document.getElementById('inputMethods');

        // Mode selection buttons
        document.getElementById('naturalsBtn').addEventListener('click', () => startMode('naturals'));
        document.getElementById('chromaticBtn').addEventListener('click', () => startMode('chromatic'));

        function startMode(mode) {
            currentMode = mode;
            
            if (mode === 'naturals') {
                activeNotes = naturalNotes;
                totalTrials = 14;
            } else {
                activeNotes = allNotes;
                totalTrials = 24;
            }
            
            switchToGameScreen();
        }

        // Randomize toggle functionality
        randomizeToggle.addEventListener('click', function() {
            isRandomized = !isRandomized;
            randomizeToggle.classList.toggle('active', isRandomized);
            updateToggleDescription();
        });

        function updateToggleDescription() {
            const noteList = currentMode === 'naturals' ? 'C, D, E, F, G, A, B' : 'C, C#, D, D#, E, F, F#, G, G#, A, A#, B';
            if (isRandomized) {
                toggleDescription.textContent = `Randomized order: All ${activeNotes.length} notes in random sequence, then repeat that same order`;
            } else {
                toggleDescription.textContent = `Fixed order: ${noteList} (repeated twice)`;
            }
        }

        function generateTrialOrder() {
            if (isRandomized) {
                const shuffledNotes = [...activeNotes];
                for (let i = shuffledNotes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledNotes[i], shuffledNotes[j]] = [shuffledNotes[j], shuffledNotes[i]];
                }
                trialOrder = [...shuffledNotes, ...shuffledNotes];
                console.log('Randomized trial order generated:', trialOrder.map(n => noteDisplayNames[n]));
            } else {
                trialOrder = [...activeNotes, ...activeNotes];
                console.log('Fixed trial order:', trialOrder.map(n => noteDisplayNames[n]));
            }
        }

        // Response handling - works for both mobile tap and desktop spacebar
        function handleResponse() {
            if (!isSequencePlaying) return;
            
            // This will be called by both spacebar and button tap
            // The actual response logic is in playNextNote's responseHandler
            const event = new KeyboardEvent('keydown', { code: 'Space' });
            document.dispatchEvent(event);
        }

        // Mobile response button
        responseButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            handleResponse();
        });

        responseButton.addEventListener('mousedown', function(e) {
            e.preventDefault();
            handleResponse();
        });

        // Prevent context menu on long press
        responseButton.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const bulkUpload = document.getElementById('bulkUpload');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => bulkUpload.click());
        bulkUpload.addEventListener('change', (e) => handleFiles(e.target.files));

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight(e) {
            dropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dropZone.classList.remove('dragover');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            [...files].forEach(processFile);
        }

        function isAudioFile(file) {
            if (file.type && file.type.startsWith('audio/')) return true;
            const fileName = file.name.toLowerCase();
            const audioExtensions = ['.wav', '.mp3', '.m4a', '.ogg', '.flac', '.aac'];
            return audioExtensions.some(ext => fileName.endsWith(ext));
        }

        function processFile(file) {
            if (!isAudioFile(file)) return;
            
            const fileName = file.name.toLowerCase();
            let noteName = '';
            
            const notePatterns = {
                'C': ['c.', 'c_'],
                'CSharp': ['csharp.', 'c#.', 'cs.', 'c_sharp.', 'c-sharp.'],
                'D': ['d.', 'd_'],
                'DSharp': ['dsharp.', 'd#.', 'ds.', 'd_sharp.', 'd-sharp.'],
                'E': ['e.', 'e_'],
                'F': ['f.', 'f_'],
                'FSharp': ['fsharp.', 'f#.', 'fs.', 'f_sharp.', 'f-sharp.'],
                'G': ['g.', 'g_'],
                'GSharp': ['gsharp.', 'g#.', 'gs.', 'g_sharp.', 'g-sharp.'],
                'A': ['a.', 'a_'],
                'ASharp': ['asharp.', 'a#.', 'as.', 'a_sharp.', 'a-sharp.'],
                'B': ['b.', 'b_']
            };
            
            for (let [note, patterns] of Object.entries(notePatterns)) {
                for (let pattern of patterns) {
                    if (fileName.startsWith(pattern) || fileName.includes('_' + pattern) || fileName.includes('-' + pattern)) {
                        noteName = note;
                        break;
                    }
                }
                if (noteName) break;
            }
            
            if (noteName) {
                if (audioFiles[noteName]) {
                    if (naturalNotes.includes(noteName)) uploadedNaturals--;
                    if (sharpNotes.includes(noteName)) uploadedSharps--;
                }
                
                const url = URL.createObjectURL(file);
                audioFiles[noteName] = new Audio(url);
                
                if (naturalNotes.includes(noteName)) uploadedNaturals++;
                if (sharpNotes.includes(noteName)) uploadedSharps++;
                
                const label = document.getElementById(`label${noteName}`);
                label.classList.add('uploaded');
                label.innerHTML = `<strong>${noteDisplayNames[noteName]}</strong><br><small>‚úì ${file.name}</small>`;
                
                updateStatus();
            }
        }

        // Individual file uploads for all notes
        allNotes.forEach(note => {
            const fileInput = document.getElementById(`file${note}`);
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) processFile(e.target.files[0]);
            });
        });

        function updateStatus() {
            const status = document.getElementById('status');
            const totalUploaded = uploadedNaturals + uploadedSharps;
            
            if (uploadedNaturals === 7 && uploadedSharps === 5) {
                status.textContent = 'All 12 chromatic notes uploaded! Choose your training mode below.';
                status.className = 'status complete';
                modeSelection.classList.add('show');
                document.getElementById('chromaticBtn').style.display = 'block';
            } else if (uploadedNaturals === 7) {
                status.textContent = 'All 7 natural notes uploaded! Choose training mode or upload sharps for chromatic mode.';
                status.className = 'status naturals-ready';
                modeSelection.classList.add('show');
                if (uploadedSharps === 0) {
                    document.getElementById('chromaticBtn').style.opacity = '0.5';
                    document.getElementById('chromaticBtn').style.pointerEvents = 'none';
                } else {
                    document.getElementById('chromaticBtn').style.opacity = '1';
                    document.getElementById('chromaticBtn').style.pointerEvents = 'auto';
                }
            } else {
                const naturalsNeeded = 7 - uploadedNaturals;
                status.textContent = `Upload ${naturalsNeeded} more natural note${naturalsNeeded !== 1 ? 's' : ''} to begin training (${totalUploaded} uploaded)`;
                status.className = 'status incomplete';
                modeSelection.classList.remove('show');
            }
        }

        function switchToGameScreen() {
            uploadScreen.classList.add('hidden');
            gameScreen.classList.add('active');
            
            const modeBadge = document.getElementById('modeBadge');
            const readyDescription = document.getElementById('readyDescription');
            const phaseIndicator = document.getElementById('phaseIndicator');
            const startBtn = document.getElementById('startBtn');
            
            if (currentMode === 'naturals') {
                modeBadge.textContent = 'NATURALS';
                modeBadge.className = 'mode-badge naturals';
                readyDescription.textContent = 'Natural notes (C-B) loaded successfully. Configure your training options below.';
                phaseIndicator.textContent = 'Ready to start - 14 trials ahead (7 notes √ó 2 repetitions)';
                startBtn.textContent = 'Start Training (14 trials)';
            } else {
                modeBadge.textContent = 'CHROMATIC';
                modeBadge.className = 'mode-badge chromatic';
                readyDescription.textContent = 'All 12 chromatic notes loaded successfully. Configure your training options below.';
                phaseIndicator.textContent = 'Ready to start - 24 trials ahead (12 notes √ó 2 repetitions)';
                startBtn.textContent = 'Start Training (24 trials)';
            }
            
            updateToggleDescription();
        }

        function switchToUploadScreen() {
            uploadScreen.classList.remove('hidden');
            gameScreen.classList.remove('active');
        }

        // Back to upload button
        document.getElementById('backToUpload').addEventListener('click', switchToUploadScreen);

        // Training functionality
        document.getElementById('startBtn').addEventListener('click', startTraining);
        document.addEventListener('keydown', handleSpacebar);

        function startTraining() {
            generateTrialOrder();
            
            currentTrial = 0;
            correctHits = 0;
            totalHits = 0;
            reactionTimes = [];
            
            randomizeToggle.style.pointerEvents = 'none';
            randomizeToggle.style.opacity = '0.5';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('readyMessage').style.display = 'none';
            inputMethods.classList.add('show');
            responseButton.classList.add('show');
            
            clearFeedback();
            nextTrial();
        }

        function nextTrial() {
            if (currentTrial >= totalTrials) {
                endTraining();
                return;
            }

            currentTrial++;
            targetNote = trialOrder[currentTrial - 1];
            
            updateStats();
            updatePhaseIndicator();
            
            document.getElementById('targetNote').textContent = noteDisplayNames[targetNote];
            clearFeedback();
            
            audioFiles[targetNote].currentTime = 0;
            audioFiles[targetNote].play();
            
            setTimeout(() => {
                startNoteSequence();
            }, 1500);
        }

        function startNoteSequence() {
            document.getElementById('targetNote').textContent = '‚ô™ Listening...';
            isSequencePlaying = true;
            currentNoteIndex = 0;
            
            noteSequence = [];
            targetPositions = [];
            
            console.log(`\n=== TRIAL ${currentTrial} - TARGET: ${noteDisplayNames[targetNote]} (${currentMode.toUpperCase()} MODE) ===`);
            
            for (let i = 0; i < 4; i++) {
                noteSequence.push(targetNote);
            }
            
            const nonTargetNotes = activeNotes.filter(note => note !== targetNote);
            for (let i = 0; i < 12; i++) {
                const randomNote = nonTargetNotes[Math.floor(Math.random() * nonTargetNotes.length)];
                noteSequence.push(randomNote);
            }
            
            for (let i = noteSequence.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [noteSequence[i], noteSequence[j]] = [noteSequence[j], noteSequence[i]];
            }
            
            targetPositions = [];
            noteSequence.forEach((note, index) => {
                if (note === targetNote) {
                    targetPositions.push(index + 1);
                }
            });
            
            const targetCount = noteSequence.filter(note => note === targetNote).length;
            console.log(`Target note (${noteDisplayNames[targetNote]}) appears ${targetCount} times`);
            console.log(`Target positions: ${targetPositions.join(', ')}`);
            console.log(`Full sequence: ${noteSequence.map(n => noteDisplayNames[n]).join(', ')}`);
            
            playNextNote();
        }

        function playNextNote() {
            if (currentNoteIndex >= 16 || !isSequencePlaying) {
                endSequence();
                return;
            }
            
            const noteToPlay = noteSequence[currentNoteIndex];
            const positionNumber = currentNoteIndex + 1;
            
            console.log(`Playing note ${positionNumber}/16: ${noteDisplayNames[noteToPlay]} ${noteToPlay === targetNote ? '(TARGET!)' : ''}`);
            
            audioFiles[noteToPlay].currentTime = 0;
            audioFiles[noteToPlay].play();
            
            const isTargetNote = noteToPlay === targetNote;
            const noteStartTime = Date.now();
            
            let responded = false;
            const responseHandler = (e) => {
                if (e.code === 'Space' && !responded) {
                    responded = true;
                    const reactionTime = Date.now() - noteStartTime;
                    
                    console.log(`Response detected! RT: ${reactionTime}ms, Target: ${isTargetNote}`);
                    
                    if (reactionTime <= 1750) {
                        totalHits++;
                        if (isTargetNote) {
                            correctHits++;
                            reactionTimes.push(reactionTime);
                            showFeedback(true, reactionTime);
                        } else {
                            showFeedback(false, reactionTime);
                        }
                    }
                    
                    document.removeEventListener('keydown', responseHandler);
                }
            };
            
            document.addEventListener('keydown', responseHandler);
            
            noteTimeout = setTimeout(() => {
                document.removeEventListener('keydown', responseHandler);
                currentNoteIndex++;
                const nextDelay = responded ? 500 : 0;
                setTimeout(playNextNote, nextDelay);
            }, 1750);
        }

        function handleSpacebar(e) {
            // This handles actual spacebar presses
            // Mobile taps are converted to spacebar events via handleResponse()
        }

        function showFeedback(correct, reactionTime) {
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback';
            
            if (correct) {
                feedback.classList.add('correct');
                feedback.textContent = `‚úì Correct! RT: ${reactionTime}ms`;
            } else {
                feedback.classList.add('incorrect');
                feedback.textContent = `‚úó False alarm! RT: ${reactionTime}ms`;
            }
            
            feedback.classList.add('show');
            
            setTimeout(() => {
                clearFeedback();
            }, 500);
        }

        function clearFeedback() {
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback empty';
            feedback.textContent = 'Feedback will appear here';
        }

        function endSequence() {
            isSequencePlaying = false;
            clearTimeout(noteTimeout);
            
            console.log(`Trial ${currentTrial} complete. Moving to next trial in 1500ms...`);
            
            setTimeout(() => {
                nextTrial();
            }, 1500);
        }

        function updatePhaseIndicator() {
            const orderType = isRandomized ? 'Randomized' : 'Fixed';
            const modeText = currentMode === 'naturals' ? 'Natural' : 'Chromatic';
            document.getElementById('phaseIndicator').textContent = 
                `Trial ${currentTrial} of ${totalTrials} - Target: ${noteDisplayNames[targetNote]} (${modeText} ${orderType})`;
        }

        function updateStats() {
            document.getElementById('trialCount').textContent = currentTrial;
            document.getElementById('correctCount').textContent = correctHits;
            
            const accuracy = totalHits > 0 ? Math.round((correctHits / totalHits) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            const avgRT = reactionTimes.length > 0 ? 
                Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length) : 0;
            document.getElementById('avgReactionTime').textContent = avgRT + 'ms';
        }

        function endTraining() {
            document.getElementById('targetNote').textContent = 'Training Complete!';
            inputMethods.classList.remove('show');
            responseButton.classList.remove('show');
            document.getElementById('readyMessage').style.display = 'block';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('startBtn').textContent = 'Start New Session';
            
            randomizeToggle.style.pointerEvents = 'auto';
            randomizeToggle.style.opacity = '1';
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback correct show';
            const orderType = isRandomized ? 'randomized' : 'fixed';
            const modeText = currentMode === 'naturals' ? 'Natural notes' : 'Chromatic';
            feedback.textContent = `${modeText} training complete! (${orderType} order) Hit accuracy: ${totalHits > 0 ? Math.round((correctHits / totalHits) * 100) : 0}%`;
            
            console.log(`\n=== ${currentMode.toUpperCase()} TRAINING SESSION COMPLETE ===`);
            console.log(`Mode: ${currentMode} (${activeNotes.length} notes)`);
            console.log(`Order type: ${isRandomized ? 'Randomized' : 'Fixed'}`);
            console.log(`Trial order was: ${trialOrder.map(n => noteDisplayNames[n]).join(', ')}`);
            console.log(`Total hits: ${totalHits}`);
            console.log(`Correct hits: ${correctHits}`);
            console.log(`Accuracy: ${totalHits > 0 ? Math.round((correctHits / totalHits) * 100) : 0}%`);
        }

        // Initialize
        updateStatus();
    </script>
</body>
</html>
